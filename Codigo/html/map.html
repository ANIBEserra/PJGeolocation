<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE-edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Geolocalização de Bairros em Santana de Parnaíba</title>

    <!-- background css-->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

    <!-- Leaflet JavaScript-->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- Geocoder-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script> 
    
    <!-- bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">

    <!-- Drawer Plugin  Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>

    <style>
    </style>

</head>

<body>
    <section class="buttons">
    <!-- Sessão de criação dos botões que filtrarão mapa -->
        <div class="fullscreen-button">
            <i class="bi bi-arrows-fullscreen fullscreen-icon" onclick="fullScreenview()" title="Tela cheia"></i> <!-- fullscreen button-->
        </div>

        <div class="print-map">
            <i class="bi bi-printer" onclick="" title="Imprimir mapa"></i> 
        </div>

        <div class="custom-search-control"></div>

        <div class="centermap">
            <i class="bi bi-align-center" id="centerMapButton" title="Centralizar mapa"></i>
        </div>

    </section>

    <div class="cabecalho">
        <img src="../img/brasao_santana.png" alt="Descrição da imagem">

    <h1> Portal Geo Parnaíba </h1>

    <div id="mapid"></div>

    <!-- Div para exibir as coordenadas GeoJSON que serão criadas no leaflet Drawer -->
    <button id="copiageojson">Copiar GeoJson</button>
    <div id="geojson-coordinates"></div>
    <div id="info"></div>

    <!-- jQuery Para coordenadas ao passar mouse -->
    <div class="coordinate"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script> <!-- coordenadas sob o mouse -->

    <!-- Camadas-->
    <script src="../dataqgiz/limiteSantana.js"></script>
    <script src="../dataqgiz/massaDaguaStn.js"></script>
    <script src="../dataqgiz/cursoDaguaStn.js"></script>
    <script src="../dataqgiz/nascentesDagua.js"></script>
    <script src="../dataqgiz/app5omNascentes.js"></script>
    <script src="../dataqgiz/app15mCursoDagua.js"></script>
    <script src="../dataqgiz/curvasDeNivelStn.js"></script>
    <script src="../dataqgiz/municipiosVizinhosStn.js"></script>
    <script src="../dataqgiz/InundacaoRiscoAlto.js"></script>
    <script src="../dataqgiz/InundacaoRiscoModerado.js"></script>
    <script src="../dataqgiz/InundacaoRiscoBaixo.js"></script>
    <script src="../dataqgiz/limitesmapaSTN.js"></script>
    <script src="../dataqgiz/AreaRiscoEscorregamento.js"></script>
    <script src="../dataqgiz/AreaRiscoInundacao.js"></script>
    <script src="../dataqgiz/AreaRiscoSolapamento.js"></script>
    <script>
        
        // Carregue o arquivo GeoJSON
        var geojson = {
        "type": "FeatureCollection",
        "features": [
            {
            "type": "Feature",
            "properties": {},
            "geometry": {
                "type": "Polygon",
                "coordinates": [
                [
                    [-47.145081, -23.523739],
                    [-47.145081, -23.337882],
                    [-46.624947, -23.337882],
                    [-46.624947, -23.523739],
                    [-47.145081, -23.523739]
                ]
                ]
            }
            }
        ]
        };

        // Extrair as coordenadas do polígono
        var coordinates = geojson.features[0].geometry.coordinates[0];

        // Converter as coordenadas em objetos LatLng
        var latLngs = coordinates.map(function(coord) {
        return L.latLng(coord[1], coord[0]);
        });

        // Criar um objeto L.latLngBounds com base nas coordenadas
        var bounds = L.latLngBounds(latLngs);

        //cria mapa
        var map = L.map('mapid', {
            minZoom: 12,
            maxZoom: 20,
            center: [-23.4431, -46.9207],
            maxBounds: bounds, 
    });
        map.setView([-23.4431, -46.9207], 7); // Define a visualização do mapa com um zoom mais próximo após a inicialização

        L.control.zoom({
            position: 'topleft'
    });
        
        //////////////////////////////////////////////////////////////////
        ///////////////////////Barra de Pesquisa///////////////////////// 

        var geocoder = L.Control.geocoder({
            position: 'topright',

        }).addTo(map);

        // Espera pelo evento de inicialização do mapa
        map.whenReady(function() {

            // Seleciona o elemento do controle de busca pela classe HTML
            var searchControl = document.querySelector('.leaflet-control-geocoder');

            // Define um evento de passagem do mouse para expandir o controle de busca
            searchControl.addEventListener('mouseenter', function() {
                this.classList.add('expanded'); // Adiciona a classe 'expanded' para expandir o botão
            });

            // Define um evento de retirada do mouse para recolher o controle de busca
            searchControl.addEventListener('mouseleave', function() {
                this.classList.remove('expanded'); // Remove a classe 'expanded' para recolher o botão
            });
        });

        //OSM layer
        var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    }).addTo(map);

        var Thunderforest_OpenCycleMap = L.tileLayer('https://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey={apikey}', {
        attribution: '&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        apikey: 'd25bc170e1b54aaf8174e8901450c4f5',
        maxZoom: 22
    });

        //tilelayers google
        googleStreets = L.tileLayer('http://{s}.google.com/vt?lyrs=m&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3'],
        layers: [],
    });

        googleSat = L.tileLayer('http://{s}.google.com/vt?lyrs=s&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    });

        googleHybrid = L.tileLayer('http://{s}.google.com/vt?lyrs=s,h&x={x}&y={y}&z={z}',{
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    });

        //////////////////////////////////////////////////////////////////
        //////////////////////GeoJson das Camadas////////////////////////

        var limiteStn = L.geoJSON(limiteSantana, {
            color: '#0D0005', 
            weight: 3, 
            fillOpacity: 0.10,
        }).addTo(map)//.bindTooltip('Santana de Parnaíba', {permanet: true}).openTooltip();

        var massadaguaStn = L.geoJSON(massadaguajs, {
            color: '#10C1FF',
            weight: 3,

    })

        var cursodaguaStn = L.geoJSON(cursoDaguajs)

        var nascentesdaguaStna = L.geoJSON(nascentesDaguajs)

        var app50mNascentesStna = L.geoJSON(app50nascjs, {
            color: '#0374C0',
            weight: 3,
        })

        var app15mCursodaguaStna = L.geoJSON(app15mCursoDjs, {
            color: '#035389',
            weight: 3,
        })

        var curvasdeNivelStna = L.geoJSON(curvasdeNiveljs, {
            color:'#FF0000',
            weight: 3,
        })

        var municipiosVizinhosStna = L.geoJSON(municipiosVizinhosjs, {
            color: '#000000', 
            weight: 3, 
        });

        var InundacaoRiscoAlto = L.geoJSON(IRiscoAltojs, {
            color: '#C10606',
            weight: 3,
        });

        var InundacaoRiscoModerado = L.geoJSON(IRiscoModeradojs, {
            color:'#FF9700',
            weight: 3,
            fillColor: '#FF9700', // Define a cor de preenchimento
            fillOpacity: 0.5 // Define a opacidade do preenchimento (opcional)
        })

        var InundacaoRiscoBaixo = L.geoJSON(IRiscoBaixojs, {
            color: '#F3FF00',
            weight: 3,
            fillColor: '#F3FF00', // Define a cor de preenchimento
            fillOpacity: 0.5 // Define a opacidade do preenchimento (opcional)
        });
        
        var areaEscorregamento = L.geoJSON(AreaEscorregamento_js, {
            color: '#786C15',
            weight: 3,
            fillOpacity: 0.5,
        });

        var areaInundacao = L.geoJSON(AreaInundacao_js, {
            color: '#062E70',
            weight: 3,
            fillOpacity: 0.5,
        });

        var areaSalopamento = L.geoJSON(AreaSolapamento_js, {
            color: '#FF8D05',
            weight: 3,
            fillOpacity: 0.5,
        })

        //Layer Control
        var baseLayers = {
            "Thunderforest_OpenCycleMap": Thunderforest_OpenCycleMap,
            "Google Maps": googleStreets,
            "Satellite Streets": googleHybrid,
            "Satellite": googleSat,
            "OSM": osm,
    }

        var overlays = {
            //"Marker": marker,
            "Limite Municipio": limiteStn,
            "Municípios vizinhos": municipiosVizinhosStna,
            "Massa Dágua Stna": massadaguaStn,
            "Curso Dágua Stna": cursodaguaStn,
            "Nascentes Dágua Stna": nascentesdaguaStna,
            "App 50m Nascentes Stna": app50mNascentesStna,
            "App 15m Curso Dagua Stna": app15mCursodaguaStna,
            "Curvas de Nível Stna": curvasdeNivelStna,
            "Inuncadação Risco Alto": InundacaoRiscoAlto,
            "Inundação Risco Moderado": InundacaoRiscoModerado,
            "Inundação Risco Baixo": InundacaoRiscoBaixo,
            "Áreas de Escorregamento": areaEscorregamento,
            "Áreas de Inundação": areaInundacao,
            "Áreas de Salopamento": areaSalopamento,

    };
        //////////////////////////////////////////////////////////////////
        //////////////////////Layer de Controle//////////////////////////

        baselayersControl = L.control.layers(baseLayers, overlays,  {position: 'topright'}).addTo(map);

        var layerControlContainer = baselayersControl.getContainer(); // Obtenha o contêiner da camada de controle
        layerControlContainer.classList.add('custom-layer-control'); // Adicione uma classe personalizada ao contêiner da camada de controle

        // Estende a classe L.Control.Layers para adicionar um botão personalizado
        L.Control.CustomLayers = L.Control.Layers.extend({
            onAdd: function(map) {
                // Chama o método onAdd da classe pai para obter o contêiner padrão
                var container = L.Control.Layers.prototype.onAdd.call(this, map);

                // Cria um botão personalizado para remover camadas selecionadas
                var button = L.DomUtil.create('button', 'custom-layers-button');
                button.innerHTML = 'Remover Camadas Selecionadas';
                button.classList.add('custom-remove-button')

                // Define a função para mostrar ou ocultar o botão com base no estado da camada de controle
                function toggleButtonVisibility() {
                    if (container.classList.contains('leaflet-control-layers-expanded')) {
                        button.style.display = 'inline-block';
                    } else {
                        button.style.display = 'none';
                    }
                }

                // Adiciona um evento de clique ao botão para remover camadas selecionadas
                button.addEventListener('click', function() {
                    var selectedLayers = [];
                    for (var layerName in overlays) {
                        if (map.hasLayer(overlays[layerName])) {
                            selectedLayers.push(overlays[layerName]);
                        }
                    }

                    selectedLayers.forEach(function(layer) {
                        map.removeLayer(layer);
                    });
                });

                // Adiciona o botão ao contêiner da camada de controle
                container.appendChild(button);

                // Adiciona um listener ao evento de click na camada de controle para atualizar a visibilidade do botão
                map.on('overlayadd overlayremove', toggleButtonVisibility);

                // Adiciona um listener ao evento de mouseover para a camada de controle para expandir o botão quando o mouse estiver sobre ela
                container.addEventListener('mouseover', function() {
                    this.classList.add('leaflet-control-layers-expanded');
                    toggleButtonVisibility();
                });

                // Adiciona um listener ao evento de mouseout para a camada de controle para recolher o botão quando o mouse sair dela
                container.addEventListener('mouseout', function() {
                    this.classList.remove('leaflet-control-layers-expanded');
                    toggleButtonVisibility();
                });

                // Inicialmente, oculta o botão até que a camada de controle seja estendida
                toggleButtonVisibility();

                return container;
            }
        });

        // Cria a layer de controle personalizada e a adiciona ao mapa
        var customLayersControl = new L.Control.CustomLayers(baseLayers, overlays, { position: 'topright' }).addTo(map);
        
        // Remove a camada de controle padrão do mapa
        map.removeControl(baselayersControl);


        //Scala do mapa
        var scale = L.control.scale({position: 'bottomright'}).addTo(map);

        ////////////////////////////////////////////////////////////
        /////////////////full screen map view//////////////////////

        window.addEventListener('scroll', function() {
        var button = document.querySelector('.fullscreen-button');
        if (window.scrollY > 0) {
            button.style.display = 'none'; // Esconde o botão quando a página é rolada para baixo
        } else {
            button.style.display = 'block'; // Mostra o botão quando a página está no topo
        }
    });

        var mapId = document.getElementById('mapid')
        function fullScreenview() {
            mapId.requestFullscreen();
    }

        ////////////////////////////////////////////////////////////
        //////////////////Centralizar mapa View////////////////////

        // Event listener for center map button
        document.getElementById("centerMapButton").addEventListener("click", function() {
            // Define a posição inicial do mapa (por exemplo, latitude e longitude)
            var initialPosition = [-23.4431, -46.9207];
            
            // Centraliza o mapa na posição inicial com um determinado zoom
            map.setView(initialPosition, 7);
        });

        ////////////////////////////////////////////////////////////
        //////////////Configura Barras de rolagem//////////////////
        
        var mapElement = document.getElementById('mapid');
        // Adiciona um ouvinte de evento para detectar quando o cursor do mouse entra no mapa
        mapElement.addEventListener('mouseenter', function() {
            // Quando o cursor do mouse entra no mapa, desativamos a rolagem da página
            document.body.style.overflow = 'hidden';
    });

        // Adiciona um ouvinte de evento para detectar quando o cursor do mouse sai do mapa
        mapElement.addEventListener('mouseleave', function() {
            // Quando o cursor do mouse sai do mapa, reativamos a rolagem da página
            document.body.style.overflow = 'auto';
    });

        ////////////////////////////////////////////////////////////
        ///////////////Configura Coordenadas Mouse/////////////////

        //Transforma coordenadas de decimal para minutos e segundos
        function decimalParaDMS(decimal) {
        var graus = Math.floor(decimal);
        var minutosDecimal = (decimal - graus) * 60;
        var minutos = Math.floor(minutosDecimal);
        var segundos = (minutosDecimal - minutos) * 60;

        return {
            graus: Math.abs(graus),
            minutos: minutos,
            segundos: segundos
            };
    }

        //Transforma coordenadas de decimal para graus
        function formatarDMS(coordenada) {
            var direcao = coordenada >= 0 ? 'N' : 'S';
            coordenada = Math.abs(coordenada);
            return coordenada + "°";
    }

        //localiza coordenadas do mouse
        var latlngCoor = map.on('mousemove', function(e) {
            var latitudeDMS = decimalParaDMS(e.latlng.lat);
            var longitudeDMS = decimalParaDMS(e.latlng.lng);
            
            var latitudeFormatada = formatarDMS(latitudeDMS.graus) + " " + latitudeDMS.minutos + "' " + latitudeDMS.segundos.toFixed(2) + "\" N";
            var longitudeFormatada = formatarDMS(longitudeDMS.graus) + " " + longitudeDMS.minutos + "' " + longitudeDMS.segundos.toFixed(2) + "\" W";
            
            $('.coordinate').html(`Lat: ${latitudeFormatada} Lng: ${longitudeFormatada}`);
    });

        ////////////////////////////////////////////////////////////
        ////////////////////////Map Print//////////////////////////

        window.addEventListener('scroll', function() {
        var printButton = document.querySelector('.print-map');
        if (window.scrollY > 0) {
            printButton.style.top = (20 + window.scrollY) + 'px'; // Ajusta a posição ao rolar; // Muda a posição para fixa quando a página é rolada para baixo
        } else {
            printButton.style.top = '20px'; // Retorna à inicial quando a página está no topo
        }
    });

        $('.print-map').click(function () {
            window.print();
    })

        ////////////////////////////////////////////////////////////
        ///////////////Leaflet Drawer Polígonos////////////////////

        //Grupo de camadas para armazenar poligonos
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        //crontrole de desenho
        var drawControl = new L.Control.Draw({
            draw: {
                polygon: true,
                marker: true,
                circlemarker: true,
                polyline: true,
                rectangle: true,
                circle: true
            },
            position: 'bottomleft',
            edit: {
                featureGroup: drawnItems
            },
    });
        map.addControl(drawControl);

        // Evento chamado quando o polígono é desenhado no mapa
        map.on(L.Draw.Event.CREATED, function (event) {
            var layer = event.layer;
            drawnItems.addLayer(layer);
            updateGeoJSONCoordinates();
            // Mostra o botão de copiar
            document.getElementById('copiageojson').style.display = 'block';
    });

        // Evento chamado quando o polígono é editado no mapa
        map.on('draw:edited', function (event) {
            updateGeoJSONCoordinates();
            // Mostra o botão de copiar
            document.getElementById('copy-geojson').style.display = 'block';
    });

        // Função para atualizar as coordenadas GeoJSON
        function updateGeoJSONCoordinates() {
            var geojsonData = drawnItems.toGeoJSON();
            var geojsonString = JSON.stringify(geojsonData, null, 2);
            document.getElementById('geojson-coordinates').innerHTML = '<pre>' + geojsonString + '</pre>';
    }

        // Evento chamado quando o botão de exclusão é clicado
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('delete-polygon').addEventListener('click', function() {
                // Verifica se existe algum polígono desenhado
                if (drawnItems.getLayers().length > 0) {
                    // Obtém o primeiro polígono desenhado e o remove do mapa
                    var layer = drawnItems.getLayers()[0];
                    drawnItems.removeLayer(layer);
                    updateGeoJSONCoordinates();
                }
            });
        });

        // Evento chamado quando o botão de cópia é clicado
        document.getElementById('copiageojson').addEventListener('click', function() {
            // Seleciona o texto dentro do contêiner das coordenadas GeoJSON
            var geojsonCoordinates = document.getElementById('geojson-coordinates');
            var range = document.createRange();
            range.selectNode(geojsonCoordinates);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            // Copia o texto selecionado para a área de transferência
            document.execCommand('copy');
            // Remove a seleção
            window.getSelection().removeAllRanges();
            // Exibe a mensagem de feedback
            var info = document.getElementById('info');
            info.innerText = 'GeoJson Copiado para área de transferência';
            info.style.display = 'block';
            // Limpa a mensagem após alguns segundos
            setTimeout(function() {
                info.style.display = 'none';
                info.innerText = '';
            }, 3000); // Limpa a mensagem após 3 segundos
        });

    </script>

</body>
</html>